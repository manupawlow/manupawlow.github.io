<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id="canvasEl"></canvas>
    <br>
    <input type="file" accept="video/mp4" onchange="start(this.files[0])">
    <script type="module">
      import getVideoFrames from "https://deno.land/x/get_video_frames@v0.0.8/mod.js"
      
      window.start = async function(file) {
        let ctx = canvasEl.getContext("2d"); 
    
        // `getVideoFrames` requires a video URL as input.
        // If you have a file/blob instead of a videoUrl, turn it into a URL like this:
        let videoUrl = URL.createObjectURL(file);
    
        let a = 0;
        await getVideoFrames({
          videoUrl,
          onFrame(frame) {  // `frame` is a VideoFrame object: https://developer.mozilla.org/en-US/docs/Web/API/VideoFrame
            
            // if (a++ > 100 && a < 102) console.log(frame);

            ctx.drawImage(frame, 0, 0, canvasEl.width, canvasEl.height);
            frame.close();
          },
          onConfig(config) {
            canvasEl.width = config.codedWidth;
            canvasEl.height = config.codedHeight;
          }
        });
        
        URL.revokeObjectURL(file); // revoke URL to prevent memory leak
      }
    </script> 
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <p>The FPS will appear here!</p>
    <video id="myVideo" width="320" height="176" controls>
      <source src="../images/avengers-short.mp4" type="video/mp4">
    </video>

    <script>
            // Part 1:
    var vid = document.querySelector("video");
    var last_media_time, last_frame_num, fps;
    var fps_rounder = [];
    var frame_not_seeked = true;
    // Part 2 (with some modifications):
    function ticker(useless, metadata) {
      var media_time_diff = Math.abs(metadata.mediaTime - last_media_time);
      var frame_num_diff = Math.abs(metadata.presentedFrames - last_frame_num);
      var diff = media_time_diff / frame_num_diff;
      if (
        diff &&
        diff < 1 &&
        frame_not_seeked &&
        fps_rounder.length < 50 &&
        vid.playbackRate === 1 &&
        document.hasFocus()
      ) {
        fps_rounder.push(diff);
        fps = Math.round(1 / get_fps_average());
        document.querySelector("p").textContent = "FPS: " + fps + ", certainty: " + fps_rounder.length * 2 + "%";
      }
      frame_not_seeked = true;
      last_media_time = metadata.mediaTime;
      last_frame_num = metadata.presentedFrames;
      vid.requestVideoFrameCallback(ticker);
    }
    vid.requestVideoFrameCallback(ticker);
    // Part 3:
    vid.addEventListener("seeked", function () {
      fps_rounder.pop();
      frame_not_seeked = false;
    });
    // Part 4:
    function get_fps_average() {
      return fps_rounder.reduce((a, b) => a + b) / fps_rounder.length;
    }
    </script>
</body>
</html>